#!/bin/bash
export TTY

( hs "$(basename "$0")" "$@" "#" "<==" "$(ps -o comm= $PPID)" 0</dev/null ) &>/dev/null

# e.g. grepfilter slugify "rosie grep -o subs net.ipv4"

input_fp="$(cat | tf txt)"

transformer="$1"
test -n "$transformer" || exit 1
shift

matcher="$1"
test -n "$matcher" || exit 1
shift

matches_fp="$(cat "$input_fp" | eval "$matcher" | uniqnosort | tf txt)"

# The matches should result in simply a list of matching tokens
# Future passes should not work on the results of previous passes

# Therefore, matches should not overlap.
# I think I need to manually remove the overlaps.
# - Find all matching tokens
# - Scan the file again, looking for the matching tokens, but return byte positions and lengths
# - Remove matches which overlap with previous matches

transformed_fp="$(cat "$matches_fp" | eval "$transformer" | tf txt)"

# Then make the literal replacements to the original file
