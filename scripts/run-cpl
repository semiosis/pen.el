#!/bin/bash
export TTY

( hs "$(basename "$0")" "$@" "#" "<==" "$(ps -o comm= $PPID)" 0</dev/null ) &>/dev/null

fp="$1"
rp="$(realpath "$fp")"

fn=$(basename -- "$fp")
dn=$(dirname "$fp")
ext="${fn##*.}"
mant="${fn%.*}"

cd "$dn"

td_pita_pl="$(mktemp -t -d td_pita_plXXXXXX || echo /dev/null)"
trap "rmdir \"$td_pita_pl\" 2>/dev/null" 0

IFS= read -r -d '' PITA_HEAD <<HEREDOC
:- use_module(library(pita)).
:- pita.
:- begin_lpad.
HEREDOC

IFS= read -r -d '' PITA_FOOT <<HEREDOC
:- end_lpad.
HEREDOC

mkdir -p "$td_pita_pl"
cd "$td_pita_pl"

printf -- "%s\n" "$PITA_HEAD" > "${mant}.pl"
cat "$rp" | awk 1 >> "${mant}.pl"
printf -- "%s\n" "$PITA_FOOT" >> "${mant}.pl"

x -sh swipl -e "?-" -s "[$mant]." -c m -i
