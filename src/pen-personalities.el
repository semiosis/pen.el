;; Personalities create Incarnations
;; A new Incarnation should be able to be generated by a Personality

(define-derived-mode person-description-mode yaml-mode "Person"
  "Person description mode")

(add-to-list 'auto-mode-alist '("\\.person\\'" . person-description-mode))

(defvar pen-personalities (make-hash-table :test 'equal)
  "Personalities are supported personality prompts")

(defvar pen-personalities-failed '())

;; (pen-personality-file-load "/home/shane/source/git/semiosis/personalities/personalities/libertyprime.person")
(defun pen-personality-file-load (fp)
  (let* ((yaml-ht (yamlmod-read-file fp))
         (incl-name (sor (ht-get yaml-ht "include")))
         (incl-fp (if (sor incl-name)
                      (f-join
                       pen-personalities-directory
                       "personalities"
                       (concat (slugify incl-name) ".person"))))
         (incl-yaml (if (and (sor incl-name)
                             (f-file-p incl-fp))
                        (pen-personality-file-load incl-fp))))
    (if incl-yaml
        (setq yaml-ht
              (ht-merge incl-yaml
                        ;; The last is overriding
                        yaml-ht)))
    yaml-ht))

(defun pen-test-personality ()
  (interactive)
  (pen-etv (pps (ht-get pen-incarnations "freckled-girl"))))

(defun pen-test-pen-expand-template-keyvals-eval-string ()
  (interactive)

  (pen-expand-template-keyvals val personality-keyvals nil nil 'eval-string))

(defun pen-test-pen-expand-template-keyvals-eval-string ()
  (interactive)

  (pen-etv
   (let ((kv '(("task" . "Write a bio about a girl who was trafficked"))))
     (eval
      `(pen-let-keyvals
        ',kv
        (eval-string "task"))))))

(defun pen-test-expand-keyvals-personalities ()
  (interactive)
  (pen-etv
   (pen-expand-template-keyvals "Biography:\n<(pf-instruct-an-ai-to-write-something/1 task)>"
                                '(("(pf-instruct-an-ai-to-write-something/1 task)" . "She was just a young girl when she was trafficked. She didn't know what was happening to her, and she certainly didn't know how to get out. She was taken from her home country and forced into a life of prostitution. She was beaten and abused, and she didn't see any way out. But she was eventually rescued, and she is now working to help other victims of trafficking. She is a powerful advocate for change, and she is determined to make a difference in the world.")))))

;; mapcar((lambda (s) (eval `(pen-let-keyvals ',def-replacement-keyvals (eval-string (s-replace-regexp "<\\([^>]*\\)>" "\\1" s))))) ("biography>)" "biography"))

;; Yes this may prompt to define all the personalities initially.
;; But I can always update them on a one-off basis.
;; This is the way it indeed should work.

;; TODO Load the personalities descriptors
;; TODO Then spawn new personalities from those descriptors
;; TODO In apostrophe, start chatbots from previously generated personalities

(defun pen-load-personalities (&optional paths)
  (interactive)

  (setq pen-personalities (make-hash-table :test 'equal))
  (setq pen-personalities-failed '())
  (noupd
   (let ((paths
          (or paths
              (-non-nil
               (mapcar 'sor (glob (concat pen-personalities-directory "/personalities" "/*.person")))))))
     (cl-loop for path in paths do
              (message (concat "pen-mode: Loading .personality file " path))

              (pen-try
               (let* ((yaml-ht (pen-personality-file-load path))

                      (full-name (ht-get yaml-ht "full-name"))
                      (bio (ht-get yaml-ht "bio"))
                      (description (ht-get yaml-ht "description"))

                      (full-name-and-bio
                       (cond
                        ((and full-name bio)
                         (concat full-name " - " bio))
                        (full-name
                         (concat full-name " - bio unknown"))
                        (bio
                         (concat "name unknown - " bio))
                        (t
                         "Mystery person")))

                      ;; load person-defs
                      (defs-htlist (pen--htlist-to-alist (ht-get yaml-ht "defs"))))

                 (ht-set yaml-ht "full-name" full-name)
                 (ht-set yaml-ht "bio" bio)
                 (ht-set yaml-ht "description" description)
                 (ht-set yaml-ht "full-name-and-bio" full-name-and-bio)
                 (ht-set yaml-ht "personality-path" path)
                 (message (concat "pen-mode: Loaded personality " full-name))
                 (ht-set pen-personalities full-name-and-bio yaml-ht))
               (add-to-list 'pen-personalities-failed path))))
   (if pen-personalities-failed
       (progn
         (message "failed:")
         (message (pen-list2str pen-personalities-failed))
         (message (concat (str (length pen-personalities-failed)) " failed"))))))

(defun pen-list-personalities ()
  (ht-keys pen-personalities))

(provide 'pen-personalities)
